# ブートデバイスの設定

まずは，ブートデバイスを直接編集して通信関連の初期設定を行います．
Tobas のイメージが書き込まれたマイクロ SD カードを用意してください．

## 準備

---

### 設定用 GUI の起動

アプリケーションメニューから`TobasBootmediaConfig`を開くか，ターミナルで以下を実行してください．
ここでは外部ボリュームを扱うため，ユーザのログインパスワードが要求されます．

```bash
$ tobas_bootmedia_config
```

![start](resources/bootmedia_config/start.png)

### ブートデバイスに接続

適当な USB カードリーダを介して，SD カードを PC に挿入してください．
Tobas イメージが正しく書き込まれていれば，GUI 上部の選択リストで SD カードが選択できるようになります．

正しい SD カードが選択されていることを確認し，`Connect`をクリックしてください．
すると，SD カードが PC にマウントされ，各種設定ページが有効になります．

![connect](resources/bootmedia_config/connect.png)

## 各種設定

---

### Hostname

Linux のホスト名を編集します．

Tobas では，デフォルトだとネットワーク上の端末を識別するためにホスト名が使用されるため，
想定されるサブネット内のホスト名がユニークである必要があります．
固定 IP での識別も可能ですが，複数機を同時に使用する場合は念の為ホスト名が被らないようにしておくことを勧めます．

`Read`をクリックすると，現在のホスト名 (デフォルトでは`tobas`) が読み込まれ，`Write`ボタンが有効になります．
ホスト名を編集し，`Write`をクリックすると新しいホスト名が SD カードに書き込まれます．
書き込み後に再度`Read`をクリックし，変更が反映されていることを確認してください．

![hostname](resources/bootmedia_config/hostname.png)

### Login Password

ログインパスワードを編集します．

デフォルトの`raspberry`のままでも動作上は問題ありませんが，
セキュリティの観点から変更することが推奨されています．

`New Password`にログインパスワードを入力し，確認のため`Confirm Password`の欄にも同じものを入力してください．
両者が一致し，かつ有効なパスワードであれば`Write`ボタンが有効になります．
`Write`をクリックすると，入力したパスワードが SD カードに書き込まれます．

![login_password](resources/bootmedia_config/login_password.png)

### SSH Keys

SSH 鍵認証の設定を行います．

Tobas では地上局からフライトコントローラ (FC) を操作するのに一部 SSH 鍵認証を用いているため，
地上局として使用する PC の公開鍵を FC に登録しておく必要があります．

`Read`をクリックすると，現在登録されている公開鍵がリストされ，他のボタンが有効になります．
最初は公開鍵が 1 つも登録されていないため，リストは空のままです．
`Add`をクリックし，出現するダイアログに地上局として使用する PC の公開鍵を入力してください．
`OK`をクリックすると，公開鍵がリストに追加されると同時に SD カードにも書き込まれます．

<!-- prettier-ignore-start -->
!!! note
    SSH公開鍵 (~/.ssh/*.pub) が存在しない場合は，ターミナルを開き`$ ssh-keygen`で作成してください．
    途中で何度かメッセージが表示されて入力が求められますが，何も入力せずにEnterキーを押して大丈夫です．
<!-- prettier-ignore-end -->

![ssh_keys](resources/bootmedia_config/ssh_keys.png)

### Wi-Fi Client

FC を Wi-Fi クライアントとして運用するための設定を行います．

Tobas は遠隔通信に ROS 2 (DDS) を用いており，
FC と地上局などの通信すべき端末は全て同じサブネットに属する必要があります．
イーサネットのみ使用する場合や，FC をアクセスポイントとして運用する場合は，この項目はスキップして構いません．

`Read`をクリックすると，現在接続できるアクセスポイントがテーブルに反映され，他のボタンが有効になります．
最初はアクセスポイントが 1 つも登録されていないため，テーブルは空のままです．
`Add`をクリックし，出現するダイアログに接続したいアクセスポイントの SSID と PSK を入力してください．
`Priority`は接続の優先度であり，複数のネットワークが利用可能な場合にはこの値が大きいほど優先されます．
`OK`をクリックすると，アクセスポイントがテーブルに追加されると同時に SD カードにも書き込まれます．

![wifi_client](resources/bootmedia_config/wifi_client.png)

### Wi-Fi Hotspot

FC を Wi-Fi アクセスポイントとして運用するための設定を行います．

前述の通り，FC と地上局の通信のためには両者が同じサブネットに属する必要がありますが，
FC 自体をアクセスポイントにしておくと，屋外での試験飛行などの際に外部のルータを用意する必要がなくて便利です．
FC を Wi-Fi クライアントとしてのみ運用する場合は，この項目はスキップして構いません．

`New SSID`と`New PSK`にそれぞれ任意の SSID と PSK を入力してください．
両者とも有効であれば`Write`ボタンが有効になります．
`Write`をクリックすると，入力した SSID と PSK が SD カードに書き込まれます．

![wifi_hotspot](resources/bootmedia_config/wifi_hotspot.png)

## 終了

---

全ての設定が完了したら，`Disconnect`をクリックしてください．
ブートデバイスがアンマウントされ，取り外し可能な状態になります．
GUI を閉じ，SD カードを適切に PC から取り外してください．

![disconnect](resources/bootmedia_config/disconnect.png)

## 次の手順へ

---

これで作業は完了です．
次は Tobas Setup Assistant を用いて最初のプロジェクトを作成します．
